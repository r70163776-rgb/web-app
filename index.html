<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniPlay — High CPM Optimized</title>
    <style>
        :root {
            --primary: #06b6d4;
            --primary-dark: #0891b2;
            --background: #071026;
            --card-bg: #0f172a;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --border: #1e293b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        
        body {
            background: var(--background);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
            flex: 1;
        }
        
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        .header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .header p {
            color: var(--text-muted);
            font-size: 15px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border);
        }
        
        .play-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 320px;
            text-align: center;
        }
        
        .score {
            font-size: 72px;
            font-weight: 800;
            margin-bottom: 16px;
            background: linear-gradient(90deg, var(--primary), #7c3aed);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .instructions {
            color: var(--text-muted);
            margin-bottom: 24px;
            font-size: 16px;
            max-width: 300px;
        }
        
        .instructions strong {
            color: var(--primary);
        }
        
        .actions {
            display: flex;
            gap: 12px;
        }
        
        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 15px;
        }
        
        button.primary {
            background: linear-gradient(90deg, var(--primary), #7c3aed);
            color: white;
        }
        
        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }
        
        button.secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
        }
        
        button.secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .sidebar h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar h2::before {
            content: "";
            display: block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary);
        }
        
        .session-info {
            margin-bottom: 24px;
        }
        
        .session-time {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .ad-status {
            margin-bottom: 24px;
        }
        
        .status-indicator {
            display: inline-block;
            padding: 6px 12px;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 20px;
            font-size: 14px;
            color: var(--primary);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }
        
        .manual-triggers {
            margin-bottom: 24px;
        }
        
        .trigger-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .trigger-buttons button {
            width: 100%;
            justify-content: center;
        }
        
        .footer {
            text-align: center;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 14px;
        }
        
        .ad-preview {
            margin-top: 20px;
            padding: 16px;
            background: rgba(6, 182, 212, 0.05);
            border-radius: 8px;
            border: 1px dashed var(--primary);
        }
        
        .ad-preview h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--primary);
        }
        
        .ad-types {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .ad-type {
            padding: 8px 12px;
            background: rgba(6, 182, 212, 0.1);
            border-radius: 6px;
            font-size: 13px;
            color: var(--primary);
        }
        
        .reward-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1003;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        
        .reward-notification.show {
            transform: translateX(0);
        }
        
        .ad-config {
            margin-top: 20px;
            padding: 16px;
            background: rgba(245, 158, 11, 0.05);
            border-radius: 8px;
            border: 1px dashed var(--warning);
        }
        
        .ad-config h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--warning);
        }
        
        .config-item {
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-muted);
        }
        
        .config-value {
            color: var(--warning);
            font-weight: 600;
        }
        
        .cpm-metrics {
            margin-top: 20px;
            padding: 16px;
            background: rgba(16, 185, 129, 0.05);
            border-radius: 8px;
            border: 1px dashed var(--success);
        }
        
        .cpm-metrics h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: var(--success);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .metric {
            display: flex;
            flex-direction: column;
        }
        
        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--success);
        }
        
        .metric-label {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        }
        
        .error-notification {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--error);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1003;
            transform: translateY(-100px);
            transition: transform 0.3s ease;
        }
        
        .error-notification.show {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>MiniPlay — High CPM Optimized</h1>
        <p>Rewarded Popup + Rewarded Interstitial + In-App Interstitial — Target: USA + Global</p>
    </div>
    
    <div class="container">
        <main>
            <div class="card">
                <div class="play-area">
                    <div class="score" id="score">0</div>
                    <div class="instructions">
                        Tap <strong>PLAY</strong> to start — first gesture will unlock ad triggers
                    </div>
                    <div class="actions">
                        <button class="primary" id="playBtn">PLAY</button>
                        <button class="secondary" id="claimBtn">CLAIM</button>
                    </div>
                </div>
            </div>
            
            <div class="ad-preview">
                <h3>Ad Formats Preview</h3>
                <div class="ad-types">
                    <div class="ad-type">Rewarded Popup</div>
                    <div class="ad-type">Rewarded Interstitial</div>
                    <div class="ad-type">In-App Interstitial</div>
                </div>
            </div>
            
            <div class="ad-config">
                <h3>In-App Interstitial Settings</h3>
                <div class="config-item">Frequency: <span class="config-value">2 ads</span></div>
                <div class="config-item">Capping: <span class="config-value">0.1 hours (6 minutes)</span></div>
                <div class="config-item">Interval: <span class="config-value">30 seconds</span></div>
                <div class="config-item">Timeout: <span class="config-value">5 seconds</span></div>
                <div class="config-item">Every Page: <span class="config-value">false</span></div>
            </div>
            
            <div class="cpm-metrics">
                <h3>CPM Performance Metrics</h3>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-value" id="estimatedCPM">$0.00</div>
                        <div class="metric-label">Estimated CPM</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="totalImpressions">0</div>
                        <div class="metric-label">Total Impressions</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="adFillRate">0%</div>
                        <div class="metric-label">Ad Fill Rate</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="sessionRevenue">$0.00</div>
                        <div class="metric-label">Session Revenue</div>
                    </div>
                </div>
            </div>
        </main>
        
        <aside>
            <div class="card">
                <div class="sidebar">
                    <div class="session-info">
                        <h2>Session</h2>
                        <div class="session-time" id="sessionTime">0s</div>
                    </div>
                    
                    <div class="ad-status">
                        <h2>Ad Status</h2>
                        <div class="status-indicator" id="engineStatus">Waiting for gesture</div>
                    </div>
                    
                    <div class="manual-triggers">
                        <h2>Manual Triggers</h2>
                        <div class="trigger-buttons">
                            <button class="primary" id="manualRewardedPopup">Rewarded Popup</button>
                            <button class="secondary" id="manualRewardedInterstitial">Rewarded Interstitial</button>
                            <button class="secondary" id="manualInAppInterstitial">In-App Interstitial</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>
    
    <div class="footer">
        Deploy to Vercel • Add domain to Monetag dashboard • Test in incognito & real devices
    </div>

    <div class="reward-notification" id="rewardNotification">
        +50 Points! Ad completed successfully.
    </div>

    <div class="error-notification" id="errorNotification">
        Ad failed to load. Please try again.
    </div>

    <!-- Monetag Ad Scripts -->
    <script type="text/javascript">
        // Real Monetag implementation - Replace with your actual publisher ID
        (function() {
            var script = document.createElement('script');
            script.src = 'https://s.monetcg.com/p/3099110.js';
            script.async = true;
            document.head.appendChild(script);
        })();
        
        // Monetag API integration
        window.monetagAPI = {
            // Real rewarded popup function
            showRewardedPopup: function(zoneId) {
                return new Promise((resolve, reject) => {
                    if (typeof show_10139509 !== 'undefined') {
                        show_10139509('pop').then(() => {
                            resolve();
                        }).catch(error => {
                            reject(error);
                        });
                    } else {
                        // Fallback for testing
                        setTimeout(() => {
                            if (Math.random() > 0.1) {
                                resolve();
                            } else {
                                reject(new Error('Ad failed to load'));
                            }
                        }, 1500);
                    }
                });
            },
            
            // Real rewarded interstitial function
            showRewardedInterstitial: function(zoneId) {
                return new Promise((resolve, reject) => {
                    if (typeof show_10139509 !== 'undefined') {
                        show_10139509().then(() => {
                            resolve();
                        }).catch(error => {
                            reject(error);
                        });
                    } else {
                        // Fallback for testing
                        setTimeout(() => {
                            if (Math.random() > 0.1) {
                                resolve();
                            } else {
                                reject(new Error('Ad failed to load'));
                            }
                        }, 2000);
                    }
                });
            },
            
            // Real in-app interstitial function
            showInAppInterstitial: function(zoneId) {
                return new Promise((resolve, reject) => {
                    if (typeof show_10139509 !== 'undefined') {
                        show_10139509({
                            type: 'inApp',
                            inAppSettings: {
                                frequency: 2,
                                capping: 0.1,
                                interval: 30,
                                timeout: 5,
                                everyPage: false
                            }
                        }).then(() => {
                            resolve();
                        }).catch(error => {
                            reject(error);
                        });
                    } else {
                        // Fallback for testing
                        setTimeout(() => {
                            if (Math.random() > 0.05) {
                                resolve();
                            } else {
                                reject(new Error('Ad failed to load'));
                            }
                        }, 1000);
                    }
                });
            }
        };
    </script>

    <script>
        // Configuration
        const CONFIG = {
            // Ad frequency settings
            capPerSession: {
                rewardedPopup: 3,
                rewardedInterstitial: 3,
                inAppInterstitial: 4
            },
            
            // Timing settings
            popunderDelayMs: 700,
            interstitialAfterSec: 20,
            pushIntervalSec: 35,
            
            // Tier settings
            tier1Multiplier: 1.5,
            globalMultiplier: 0.7,
            
            // CPM rates (estimated)
            cpmRates: {
                tier1: {
                    rewardedPopup: 12.50,
                    rewardedInterstitial: 18.75,
                    inAppInterstitial: 8.25
                },
                global: {
                    rewardedPopup: 4.20,
                    rewardedInterstitial: 6.80,
                    inAppInterstitial: 2.75
                }
            },
            
            // Storage
            storageKey: 'mp_highcpm_optimized_session'
        };

        // State management
        let sessionData = {
            sessionId: Date.now(),
            score: 0,
            sessionTime: 0,
            adCounts: {
                rewardedPopup: 0,
                rewardedInterstitial: 0,
                inAppInterstitial: 0
            },
            adImpressions: {
                rewardedPopup: 0,
                rewardedInterstitial: 0,
                inAppInterstitial: 0
            },
            adFailures: {
                rewardedPopup: 0,
                rewardedInterstitial: 0,
                inAppInterstitial: 0
            },
            lastInAppInterstitial: 0,
            firstGestureDone: false,
            userTier: 'global',
            totalRevenue: 0
        };

        // DOM elements
        const scoreEl = document.getElementById('score');
        const sessionTimeEl = document.getElementById('sessionTime');
        const engineStatusEl = document.getElementById('engineStatus');
        const playBtn = document.getElementById('playBtn');
        const claimBtn = document.getElementById('claimBtn');
        const manualRewardedPopup = document.getElementById('manualRewardedPopup');
        const manualRewardedInterstitial = document.getElementById('manualRewardedInterstitial');
        const manualInAppInterstitial = document.getElementById('manualInAppInterstitial');
        const rewardNotification = document.getElementById('rewardNotification');
        const errorNotification = document.getElementById('errorNotification');
        
        // CPM metrics elements
        const estimatedCPMEl = document.getElementById('estimatedCPM');
        const totalImpressionsEl = document.getElementById('totalImpressions');
        const adFillRateEl = document.getElementById('adFillRate');
        const sessionRevenueEl = document.getElementById('sessionRevenue');

        // Timer
        let sessionTimer = null;

        // Initialize
        function init() {
            // Load saved session data
            const saved = localStorage.getItem(CONFIG.storageKey);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Only restore if session is from today
                    const today = new Date().toDateString();
                    const savedDay = new Date(parsed.sessionId).toDateString();
                    if (today === savedDay) {
                        sessionData = parsed;
                        updateUI();
                        updateCPMMetrics();
                    }
                } catch (e) {
                    console.log('No valid session data found');
                }
            }
            
            // Set up event listeners
            playBtn.addEventListener('click', handlePlay);
            claimBtn.addEventListener('click', handleClaim);
            manualRewardedPopup.addEventListener('click', triggerRewardedPopup);
            manualRewardedInterstitial.addEventListener('click', triggerRewardedInterstitial);
            manualInAppInterstitial.addEventListener('click', triggerInAppInterstitial);
            
            // Start session timer if we have an active session
            if (sessionData.sessionTime > 0) {
                startSessionTimer();
            }
            
            // Detect user tier
            detectUserTier();
            
            // Preload ads
            setTimeout(preloadAds, 1000);
        }

        // Update UI with current state
        function updateUI() {
            scoreEl.textContent = sessionData.score;
            sessionTimeEl.textContent = `${sessionData.sessionTime}s`;
        }

        // Update CPM metrics
        function updateCPMMetrics() {
            const totalImpressions = 
                sessionData.adImpressions.rewardedPopup + 
                sessionData.adImpressions.rewardedInterstitial + 
                sessionData.adImpressions.inAppInterstitial;
                
            const totalRequests = totalImpressions + 
                sessionData.adFailures.rewardedPopup + 
                sessionData.adFailures.rewardedInterstitial + 
                sessionData.adFailures.inAppInterstitial;
                
            const fillRate = totalRequests > 0 ? (totalImpressions / totalRequests) * 100 : 0;
            
            // Calculate estimated CPM
            const cpmRate = sessionData.userTier === 'tier1' ? 
                CONFIG.cpmRates.tier1 : CONFIG.cpmRates.global;
                
            const estimatedCPM = (
                (sessionData.adImpressions.rewardedPopup * cpmRate.rewardedPopup) +
                (sessionData.adImpressions.rewardedInterstitial * cpmRate.rewardedInterstitial) +
                (sessionData.adImpressions.inAppInterstitial * cpmRate.inAppInterstitial)
            ) / 1000; // Convert to dollars
            
            totalImpressionsEl.textContent = totalImpressions;
            adFillRateEl.textContent = `${fillRate.toFixed(1)}%`;
            estimatedCPMEl.textContent = `$${estimatedCPM.toFixed(2)}`;
            sessionRevenueEl.textContent = `$${sessionData.totalRevenue.toFixed(2)}`;
        }

        // Start session timer
        function startSessionTimer() {
            if (sessionTimer) return;
            
            sessionTimer = setInterval(() => {
                sessionData.sessionTime++;
                sessionTimeEl.textContent = `${sessionData.sessionTime}s`;
                saveSession();
                
                // Check for in-app interstitial after engagement period
                if (sessionData.sessionTime === CONFIG.interstitialAfterSec) {
                    if (canTriggerInAppInterstitial()) {
                        triggerInAppInterstitial();
                    }
                }
                
                // Trigger additional ads based on session time
                if (sessionData.sessionTime % CONFIG.pushIntervalSec === 0) {
                    triggerSmartAd();
                }
            }, 1000);
        }

        // Stop session timer
        function stopSessionTimer() {
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
        }

        // Handle play button click
        function handlePlay() {
            // Increase score
            sessionData.score += Math.floor(Math.random() * 10) + 1;
            scoreEl.textContent = sessionData.score;
            
            // Start session if not already started
            if (sessionData.sessionTime === 0) {
                startSessionTimer();
            }
            
            // Handle first gesture for ad rotation
            if (!sessionData.firstGestureDone) {
                sessionData.firstGestureDone = true;
                engineStatusEl.textContent = 'Ad rotation active';
                
                // Trigger initial ad with delay
                setTimeout(() => {
                    triggerInitialAd();
                }, CONFIG.popunderDelayMs);
            }
            
            saveSession();
        }

        // Handle claim button click
        function handleClaim() {
            alert(`Congratulations! You've earned ${sessionData.score} points. Total session revenue: $${sessionData.totalRevenue.toFixed(2)}`);
        }

        // Trigger initial ad based on user tier and availability
        function triggerInitialAd() {
            const isTier1 = sessionData.userTier === 'tier1';
            
            // Prefer rewarded popup for Tier-1 users, rewarded interstitial for others
            if (isTier1 && sessionData.adCounts.rewardedPopup < CONFIG.capPerSession.rewardedPopup) {
                triggerRewardedPopup();
            } else if (sessionData.adCounts.rewardedInterstitial < CONFIG.capPerSession.rewardedInterstitial) {
                triggerRewardedInterstitial();
            } else {
                triggerInAppInterstitial();
            }
        }

        // Smart ad triggering based on performance
        function triggerSmartAd() {
            // Calculate which ad type has the best fill rate
            const popupFillRate = sessionData.adImpressions.rewardedPopup / 
                (sessionData.adImpressions.rewardedPopup + sessionData.adFailures.rewardedPopup) || 0;
            const interstitialFillRate = sessionData.adImpressions.rewardedInterstitial / 
                (sessionData.adImpressions.rewardedInterstitial + sessionData.adFailures.rewardedInterstitial) || 0;
            
            // Trigger the ad with the best performance that hasn't reached its cap
            if (popupFillRate >= interstitialFillRate && 
                sessionData.adCounts.rewardedPopup < CONFIG.capPerSession.rewardedPopup) {
                triggerRewardedPopup();
            } else if (sessionData.adCounts.rewardedInterstitial < CONFIG.capPerSession.rewardedInterstitial) {
                triggerRewardedInterstitial();
            } else if (canTriggerInAppInterstitial()) {
                triggerInAppInterstitial();
            }
        }

        // Trigger rewarded popup ad
        function triggerRewardedPopup() {
            if (sessionData.adCounts.rewardedPopup >= CONFIG.capPerSession.rewardedPopup) {
                engineStatusEl.textContent = 'Rewarded popup cap reached';
                return;
            }
            
            // Show loading state
            engineStatusEl.textContent = 'Loading rewarded popup...';
            
            // Use Monetag API for rewarded popup
            window.monetagAPI.showRewardedPopup()
                .then(() => {
                    // User watched ad till the end
                    sessionData.adImpressions.rewardedPopup++;
                    const points = sessionData.userTier === 'tier1' ? 75 : 50;
                    rewardUser(points, 'Rewarded Popup');
                    sessionData.adCounts.rewardedPopup++;
                    
                    // Calculate revenue
                    const cpmRate = sessionData.userTier === 'tier1' ? 
                        CONFIG.cpmRates.tier1.rewardedPopup : CONFIG.cpmRates.global.rewardedPopup;
                    sessionData.totalRevenue += cpmRate / 1000;
                    
                    saveSession();
                    updateCPMMetrics();
                })
                .catch(error => {
                    // User got error during playing ad
                    console.error('Rewarded popup error:', error);
                    sessionData.adFailures.rewardedPopup++;
                    showError('Rewarded popup failed to load');
                    updateCPMMetrics();
                });
        }

        // Trigger rewarded interstitial ad
        function triggerRewardedInterstitial() {
            if (sessionData.adCounts.rewardedInterstitial >= CONFIG.capPerSession.rewardedInterstitial) {
                engineStatusEl.textContent = 'Rewarded interstitial cap reached';
                return;
            }
            
            // Show loading state
            engineStatusEl.textContent = 'Loading rewarded interstitial...';
            
            // Use Monetag API for rewarded interstitial
            window.monetagAPI.showRewardedInterstitial()
                .then(() => {
                    // User watched ad till the end
                    sessionData.adImpressions.rewardedInterstitial++;
                    const points = sessionData.userTier === 'tier1' ? 150 : 100;
                    rewardUser(points, 'Rewarded Interstitial');
                    sessionData.adCounts.rewardedInterstitial++;
                    
                    // Calculate revenue
                    const cpmRate = sessionData.userTier === 'tier1' ? 
                        CONFIG.cpmRates.tier1.rewardedInterstitial : CONFIG.cpmRates.global.rewardedInterstitial;
                    sessionData.totalRevenue += cpmRate / 1000;
                    
                    saveSession();
                    updateCPMMetrics();
                })
                .catch(error => {
                    // User got error during playing ad
                    console.error('Rewarded interstitial error:', error);
                    sessionData.adFailures.rewardedInterstitial++;
                    showError('Rewarded interstitial failed to load');
                    updateCPMMetrics();
                });
        }

        // Check if we can trigger in-app interstitial
        function canTriggerInAppInterstitial() {
            const now = Date.now();
            const timeSinceLast = now - sessionData.lastInAppInterstitial;
            
            // Check if we've reached the cap
            if (sessionData.adCounts.inAppInterstitial >= CONFIG.capPerSession.inAppInterstitial) {
                return false;
            }
            
            // Check if enough time has passed since last interstitial (30 seconds)
            if (timeSinceLast < 30000) {
                return false;
            }
            
            return true;
        }

        // Trigger in-app interstitial ad
        function triggerInAppInterstitial() {
            if (!canTriggerInAppInterstitial()) {
                engineStatusEl.textContent = 'In-app interstitial not available';
                return;
            }
            
            // Show loading state
            engineStatusEl.textContent = 'Loading in-app interstitial...';
            
            // Use Monetag API for in-app interstitial
            window.monetagAPI.showInAppInterstitial()
                .then(() => {
                    // Interstitial shown successfully
                    sessionData.adImpressions.inAppInterstitial++;
                    engineStatusEl.textContent = 'In-app interstitial completed';
                    sessionData.adCounts.inAppInterstitial++;
                    sessionData.lastInAppInterstitial = Date.now();
                    
                    // Calculate revenue
                    const cpmRate = sessionData.userTier === 'tier1' ? 
                        CONFIG.cpmRates.tier1.inAppInterstitial : CONFIG.cpmRates.global.inAppInterstitial;
                    sessionData.totalRevenue += cpmRate / 1000;
                    
                    saveSession();
                    updateCPMMetrics();
                })
                .catch(error => {
                    // Failed to show interstitial
                    console.error('In-app interstitial error:', error);
                    sessionData.adFailures.inAppInterstitial++;
                    showError('In-app interstitial failed to load');
                    updateCPMMetrics();
                });
        }

        // Reward user function
        function rewardUser(points, adType) {
            sessionData.score += points;
            updateUI();
            
            // Show reward notification
            rewardNotification.textContent = `+${points} Points! ${adType} completed successfully.`;
            rewardNotification.classList.add('show');
            
            setTimeout(() => {
                rewardNotification.classList.remove('show');
            }, 3000);
            
            engineStatusEl.textContent = `Rewarded ${points} points from ${adType}`;
        }

        // Show error notification
        function showError(message) {
            errorNotification.textContent = message;
            errorNotification.classList.add('show');
            
            setTimeout(() => {
                errorNotification.classList.remove('show');
            }, 3000);
            
            engineStatusEl.textContent = message;
        }

        // Detect user tier (improved)
        function detectUserTier() {
            // More sophisticated tier detection
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const language = navigator.language;
            const languages = navigator.languages || [navigator.language];
            
            // Check for US/Canada
            const isUSTier = 
                timezone.includes('America') || 
                language.includes('en-US') || 
                language.includes('en_CA') ||
                languages.some(lang => lang.includes('en-US') || lang.includes('en-CA'));
            
            // Check for other high-value English-speaking countries
            const isHighValueTier = 
                language.includes('en-GB') || 
                language.includes('en-AU') ||
                languages.some(lang => lang.includes('en-GB') || lang.includes('en-AU'));
            
            if (isUSTier) {
                sessionData.userTier = 'tier1';
                CONFIG.tier1Multiplier = 1.5;
            } else if (isHighValueTier) {
                sessionData.userTier = 'tier1';
                CONFIG.tier1Multiplier = 1.25;
            } else {
                sessionData.userTier = 'global';
            }
            
            console.log(`User tier detected: ${sessionData.userTier}`);
        }

        // Preload ads for better performance
        function preloadAds() {
            // In a real implementation, this would preload ad scripts
            console.log('Preloading ads for better performance...');
        }

        // Save session data to localStorage
        function saveSession() {
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(sessionData));
        }

        // Initialize the app
        init();
    </script>
</body>
</html>
